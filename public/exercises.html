<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>View Exercise</title>
  <link rel="stylesheet" href="styles/exercises.css"/>
</head>
<body>
  <h1>Exercise Details</h1>
  <div id="exercise-details"></div>
  <div id="status" style="margin-top:1em; font-style:italic;"></div>
  <div id="back"></div>

  <script>
    async function loadExercise() {
      // 1) fetch translations & build lookups
      const translationsArray = await fetch('translations.json')
        .then(res => res.json())
        .catch(e => { console.error('translations.json load failed', e); return []; });

      // conlang → English
      const clToEn = Object.fromEntries(
        translationsArray.map(({conlang, translation}) => [conlang, translation])
      );
      // English → conlang (invert)
      const enToCl = Object.fromEntries(
        translationsArray.map(({conlang, translation}) => [translation, conlang])
      );

      // 2) fetch the exercise data
      const urlParams = new URLSearchParams(window.location.search);
      const lessonId = urlParams.get('lesson_id');
      const exerciseId = urlParams.get('exercise_id');
      if (!lessonId || !exerciseId) {
        document.getElementById('exercise-details')
          .innerText = 'Missing lesson_id or exercise_id in URL';
        return;
      }

      const exercises = await fetch(`/api/exercises?lesson_id=${lessonId}`)
        .then(r => r.json())
        .catch(e => {
          console.error('exercises API failed', e);
          document.getElementById('exercise-details')
            .innerText = 'Failed to load exercise data';
          return [];
        });

      const exercise = exercises.find(ex => ex.id === exerciseId);
      if (!exercise) {
        document.getElementById('exercise-details').innerText = 'Exercise not found';
        return;
      }

      // 3) render prompt & buttons
      const container = document.getElementById('exercise-details');
      container.innerHTML = `
        <h2>${exercise.prompt}</h2>
        <div id="options-container"></div>`;
      document.getElementById('back')
        .innerHTML = `<a href="lessons?lesson_id=${lessonId}">Back</a>`;

      if (exercise.type === 'multiple_choice') {
        const options = JSON.parse(exercise.options);
        const correctAnswer = exercise.correct_answer;
        const statusDiv = document.getElementById('status');
        const optsCon = document.getElementById('options-container');

        options.forEach((option, i) => {
          const btn = document.createElement('button');
          btn.textContent = option;
          btn.title = clToEn[option] || '';  // native tooltip

          // click to answer
          btn.addEventListener('click', () => {
            if (option === correctAnswer) {
              btn.style.backgroundColor = 'lightgreen';
              statusDiv.textContent = '✅ Correct!';
            } else {
              btn.style.backgroundColor = 'salmon';
              statusDiv.textContent = '❌ Incorrect. Try again!';
            }
          });

          optsCon.appendChild(btn);
        });
      }

      // 4) wire up custom <translate-english> and <translate-tsevhu> tags
      const statusDiv = document.getElementById('status');

      // helper to attach hover behavior
      function attachTagBehavior(tagName, lookupMap) {
        document
          .querySelectorAll(tagName)
          .forEach(el => {
            const key = el.textContent.trim();
            const translation = lookupMap[key] || '(no entry)';
            el.title = translation;  // native tooltip
            el.style.cursor = 'help';

            el.addEventListener('mouseenter', () => {
              statusDiv.textContent = translation;
            });
            el.addEventListener('mouseleave', () => {
              statusDiv.textContent = '';
            });
          });
      }

      // <translate-english> shows Conlang on hover
      attachTagBehavior('translate-english', enToCl);
      // <translate-tsevhu> shows English on hover
      attachTagBehavior('translate-tsevhu', clToEn);
    }

    loadExercise();
  </script>
</body>
</html>
