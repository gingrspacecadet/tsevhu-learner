<!DOCTYPE html>
<html>
<head>
  <title>View Exercise</title>
  <link rel="stylesheet" href="styles/exercises.css"/>
</head>
<body>
  <h1>Exercise Details</h1>
  <div id="exercise-details"></div>
  <div id="status"></div>
  <div id="back"></div>

  <script>
    async function loadExercise() {
      const [translationsRes, exerciseRes] = await Promise.all([
        fetch('translations.json'),
        (async () => {
          const urlParams = new URLSearchParams(window.location.search);
          const lessonId = urlParams.get('lesson_id');
          const exerciseId = urlParams.get('exercise_id');
          if (!lessonId || !exerciseId) {
            document.getElementById('exercise-details').innerText = 'Missing lesson_id or exercise_id in URL';
            throw new Error('Missing params');
          }
          const res = await fetch(`/api/exercises?lesson_id=${lessonId}`);
          res.lessonId = lessonId;
          res.exerciseId = exerciseId;
          return res;
        })()
      ]);
  
      // load translations.json
      let translationsArray = [];
      try {
        translationsArray = await translationsRes.json();
      } catch (e) {
        console.error('Failed to load translations.json:', e);
      }
      // build lookup map: { conlangWord: translation }
      const lookup = Object.fromEntries(
        translationsArray.map(({conlang, translation}) => [conlang, translation])
      );
  
      // now load exercises
      let exercises = [];
      try {
        exercises = await exerciseRes.json();
      } catch (e) {
        console.error("Failed to parse exercises JSON:", e);
        document.getElementById('exercise-details').innerText = 'Failed to load exercise data';
        return;
      }
      const lessonId = exerciseRes.lessonId;
      const exerciseId = exerciseRes.exerciseId;
      const exercise = exercises.find(ex => ex.id === exerciseId);
      if (!exercise) {
        document.getElementById('exercise-details').innerText = 'Exercise not found';
        return;
      }
  
      // render prompt + buttons
      const container = document.getElementById('exercise-details');
      container.innerHTML = `<h2>${exercise.prompt}</h2><div id="options-container"></div>`;
      document.getElementById('back').innerHTML = `<a href="lessons?lesson_id=${lessonId}">Back</a>`;
  
      if (exercise.type === 'multiple_choice') {
        const options = JSON.parse(exercise.options);
        const correctAnswer = exercise.correct_answer;
        const optionsContainer = document.getElementById('options-container');
        const statusDiv = document.getElementById('status');
  
        options.forEach((option, i) => {
          const btn = document.createElement('button');
          btn.id = `opt-${i}`;
          btn.textContent = option;
  
          // native tooltip
          btn.title = lookup[option] || '';
  
          // click to answer
          btn.addEventListener('click', () => {
            if (option === correctAnswer) {
              btn.style.backgroundColor = 'lightgreen';
              statusDiv.textContent = '✅ Correct!';
            } else {
              btn.style.backgroundColor = 'salmon';
              statusDiv.textContent = '❌ Incorrect. Try again!';
            }
          });
  
          optionsContainer.appendChild(btn);
        });
      }
    }
  
    loadExercise();
  </script>
   
</body>
</html>
